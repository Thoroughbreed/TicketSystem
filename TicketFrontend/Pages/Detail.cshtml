@page "{ticketId?}"
@model TicketFrontend.Pages.Detail

@if (Model.FoundTicket == null)
{
    <div class="row">
        <div class="col-6">
            <H3>Ingen ticket fundet - hvad gjorde du?!</H3>
        </div>
    </div>    
}
else
{
    <form method="post">
        <div class="row">
            <div class="col-6">
                <input asp-for="FoundTicket.TCaption" hidden="true" />
                <input asp-for="FoundTicket.ID" hidden="true" />
                @* <input asp-for="FoundTicket.TRequesterID" hidden="true" /> *@
                <H3>@Model.FoundTicket.TCaption - #@Model.FoundTicket.ID</H3> @* - @Model.FoundTicket.Requester.full_name*@
            </div>
        </div>
        <div class="row">
        <div class="col-6">
            @if (User.HasClaim("https://hartmann-group.net/accessToken/roles", "TicketWrite"))
            {
                <textarea style="resize:none" rows="12" cols="75" asp-for="FoundTicket.TDesc"></textarea>
            }
            else
            {
                <textarea readonly style="resize:none" rows="12" cols="75" asp-for="FoundTicket.TDesc"></textarea>
            }
        </div>
            <div class="col-6">
                <div class="row border border-info">
                    <div class="row m-1">
                        <div class="col-12">
                            <label>Status:</label>
                            <select asp-for="FoundTicket.TStatusID" asp-items="@(new SelectList(Model.Status, "ID", "status"))">
                                <option>Vælg status</option>
                            </select>
                            <label>Prioritet:</label>
                            <select asp-for="FoundTicket.TPriorityID" asp-items="@(new SelectList(Model.Priorities, "ID", "priority"))">
                                <option>Vælg prioritet</option>
                            </select>
                            <label>Kategori:</label>
                            <select asp-for="FoundTicket.TCategoryID" asp-items="@(new SelectList(Model.Categories, "ID", "category"))">
                                <option>Vælg kategori</option>
                            </select>
                        </div>
                    </div>
                    <div class="row m-1">
                        <div class="progress">
                            <div class="progress-bar @Model.ProgressBarCol" role="progressbar" style="width: @Model.ProgressBar%;" aria-valuenow="@Model.ProgressBar" aria-valuemin="0" aria-valuemax="100">@Model.FoundTicket.Status.status</div>
                        </div>
                    </div>
                </div>
                <hr/>
                <input asp-for="FoundTicket.TCreatorID" hidden="true" />
                <label>Created by: @Model.FoundTicket.Creator.display_name</label><br/>
                <input asp-for="FoundTicket.TCreatedAt" hidden="true" />
                <label>Created at: @Model.FoundTicket.TCreatedAt</label>
                <hr/>
                @if (Model.FoundTicket.TAssignedID != null)
                {
                    <label>Assigned to: </label>
                }
                <select asp-for="FoundTicket.TAssignedID" asp-items="@(new SelectList(Model.Users, "ID", "full_name"))">
                    <option>Tildel til</option>
                </select>
                
                @if (Model.Changelogs.Count > 0)
                {
                    <hr/>
                    <label>Last changed: @Model.Changelogs.OrderByDescending(c => c.EditedAt).FirstOrDefault().EditedAt</label>
                    <br/>
                    <label>Changed by: @Model.Changelogs.OrderByDescending(c => c.EditedAt).FirstOrDefault().User.display_name</label>
                    <br/>
                }
                @if (User.HasClaim("https://hartmann-group.net/accessToken/roles", "TicketWrite"))
                {
                    @if (Model.FoundTicket.TClosed)
                    {
                        <hr/>
                        <label>Closed: @Model.FoundTicket.TClosedAt</label><br/>
                        <label>Closed by: @Model.FoundTicket.Closer.display_name</label><br/>
                            <input type="submit" asp-page-handler="ReOpen" class="btn btn-outline-danger" value="Genåbn sag"/>
                    }
                    else
                    {
                        <hr/>
                        <div class="row">
                            <div class="col">
                                <input type="submit" asp-page-handler="SaveTicket" class="btn btn-outline-warning" value="Gem ændringer"/>
                            </div>
                            <div class="col">
                                <input type="submit" asp-page-handler="CloseTicket" class="btn btn-danger" value="Luk sag"/>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </form>
    <hr/>
<div class="row">
    <div class="col-6">
        <form method="post" asp-page-handler="CreateComment">
            <H5>Kommentar</H5>
            <input asp-for="Comment.TicketID" value="@Model.FoundTicket.ID" hidden="true" />
            <input asp-for="Comment.UserID" value="@Model.UserID" hidden="true" />
            @if (User.HasClaim("https://hartmann-group.net/accessToken/roles", "TicketWrite"))
            {
                <textarea style="resize: none" rows="3" cols="75" asp-for="Comment.Comment" ></textarea>
                <input type="submit" class="btn btn-success" value="Send" />
            }
            else
            {
                <textarea style="resize: none" rows="3" cols="75" asp-for="Comment.Comment" readonly></textarea>
            }
        </form>
    </div>
</div>
    <div class="row">
        <div class="col-6">
            @foreach (var comment in Model.FoundTicket.Comments)
            {
                <div class="row border border-info rounded m-2">
                    <div class="col-6">
                        <p>@comment.Comment</p>
                    </div>
                    <div class="col-6">
                        <label>Created by: @comment.User.display_name</label>
                        <label>Created at: @comment.CTime</label>
                    </div>
                </div>    
            }
        </div>
        <div class="col-6">
            @foreach(var log in Model.Changelogs)
            {
                <div class="row border border-warning rounded m-2">
                    <div class="col-6">
                        <p>@log.LogText</p>
                    </div>
                    <div class="col-6">
                        <label>Changed by: @log.User.display_name</label>
                        <label>Changed at: @log.EditedAt</label>
                    </div>
                </div>
            }
        </div>
    </div>
}